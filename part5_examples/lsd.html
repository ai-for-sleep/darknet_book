
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>lsd.c · DarkNet Book</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="JJM">
        
        
    
    

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-advanced-emoji/emoji-website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-api/theme-api.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../website-1600186244488.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
    
    
    

    
    <link rel="next" href="nightmare.html" />
    
    
    <link rel="prev" href="instance-segmenter.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            <div class="book-logo">   
                
                <img src="/darknet_book/assets/darknet.png"/>
                
            </div>
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
        <li class="header ">DARKNET</li>
        
        
    
        
        <li class="chapter 
              "
            data-level="1.1" 
            data-path="../">

            
                <a href="../">
            
                    
                    DarkNet
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="1.2" 
            data-path="../INSTALL.html">

            
                <a href="../INSTALL.html">
            
                    
                    설치하기
            
                </a>
            

            
        </li>
    

    
        
        
        <li class="header ">Paper</li>
        
        
    
        
        <li class="chapter 
              "
            data-level="2.1" 
            data-path="../part1_paper/yolov1.html">

            
                <a href="../part1_paper/yolov1.html">
            
                    
                    YOLOv1
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="2.2" 
            data-path="../part1_paper/yolov2.html">

            
                <a href="../part1_paper/yolov2.html">
            
                    
                    YOLOv2
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="2.3" 
            data-path="../part1_paper/yolov3.html">

            
                <a href="../part1_paper/yolov3.html">
            
                    
                    YOLOv3
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="2.4" 
            data-path="../part1_paper/yolov4.html">

            
                <a href="../part1_paper/yolov4.html">
            
                    
                    YOLOv4
            
                </a>
            

            
        </li>
    

    
        
        
        <li class="header ">SOURCE</li>
        
        
    
        
        <li class="chapter 
              "
            data-level="3.1" 
            data-path="../part2_source/0_Project.html">

            
                <a href="../part2_source/0_Project.html">
            
                    
                    project
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="3.2" 
            data-path="../part2_source/1_DATA.html">

            
                <a href="../part2_source/1_DATA.html">
            
                    
                    /data
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="3.3" 
            data-path="../part2_source/2_CFG.html">

            
                <a href="../part2_source/2_CFG.html">
            
                    
                    /cfg
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="3.4" 
            data-path="../part2_source/3_EXAMPLE.html">

            
                <a href="../part2_source/3_EXAMPLE.html">
            
                    
                    /example
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="3.5" 
            data-path="../part2_source/4_SRC.html">

            
                <a href="../part2_source/4_SRC.html">
            
                    
                    /src
            
                </a>
            

            
        </li>
    

    
        
        
        <li class="header ">Structure</li>
        
        
    
        
        <li class="chapter 
              "
            data-level="4.1" 
            data-path="../part4_structure/network.html">

            
                <a href="../part4_structure/network.html">
            
                    
                    network
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="4.2" 
            data-path="../part4_structure/layer.html">

            
                <a href="../part4_structure/layer.html">
            
                    
                    layer
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="4.3" 
            data-path="../part4_structure/etc.html">

            
                <a href="../part4_structure/etc.html">
            
                    
                    etc
            
                </a>
            

            
        </li>
    

    
        
        
        <li class="header ">/SRC</li>
        
        
    
        
        <li class="chapter 
              "
            data-level="5.1" 
            data-path="../part3_src/activation_layer.html">

            
                <a href="../part3_src/activation_layer.html">
            
                    
                    activation_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.2" 
            data-path="../part3_src/activations_1.html">

            
                <a href="../part3_src/activations_1.html">
            
                    
                    activations.c
            
                </a>
            

            
            <ul class="articles">
                
                
    
        
        <li class="chapter 
               hide "
            data-level="5.2.1" 
            data-path="../part3_src/activations_2.html">

            
                <a href="../part3_src/activations_2.html">
            
                    
                    activation.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.3" 
            data-path="../part3_src/avgpool.html">

            
                <a href="../part3_src/avgpool.html">
            
                    
                    avgpool_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.4" 
            data-path="../part3_src/batchnorm_layer.html">

            
                <a href="../part3_src/batchnorm_layer.html">
            
                    
                    batchnorm_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.5" 
            data-path="../part3_src/blas.html">

            
                <a href="../part3_src/blas.html">
            
                    
                    blas.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.6" 
            data-path="../part3_src/box.html">

            
                <a href="../part3_src/box.html">
            
                    
                    box.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.7" 
            data-path="../part3_src/col2im.html">

            
                <a href="../part3_src/col2im.html">
            
                    
                    col2im.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.8" 
            data-path="../part3_src/compare.html">

            
                <a href="../part3_src/compare.html">
            
                    
                    compare.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.9" 
            data-path="../part3_src/connected_layer.html">

            
                <a href="../part3_src/connected_layer.html">
            
                    
                    connected_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.10" 
            data-path="../part3_src/convolutional_layer.html">

            
                <a href="../part3_src/convolutional_layer.html">
            
                    
                    convolutional_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.11" 
            data-path="../part3_src/cost_layer.html">

            
                <a href="../part3_src/cost_layer.html">
            
                    
                    cost_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.12" 
            data-path="../part3_src/crnn_layer.html">

            
                <a href="../part3_src/crnn_layer.html">
            
                    
                    crnn_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.13" 
            data-path="../part3_src/crop_layer.html">

            
                <a href="../part3_src/crop_layer.html">
            
                    
                    crop_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.14" 
            data-path="../part3_src/data.html">

            
                <a href="../part3_src/data.html">
            
                    
                    data.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.15" 
            data-path="../part3_src/deconvolutional_layer.html">

            
                <a href="../part3_src/deconvolutional_layer.html">
            
                    
                    deconvolutional_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.16" 
            data-path="../part3_src/demo.html">

            
                <a href="../part3_src/demo.html">
            
                    
                    demo.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.17" 
            data-path="../part3_src/detection_layer.html">

            
                <a href="../part3_src/detection_layer.html">
            
                    
                    detection_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.18" 
            data-path="../part3_src/dropout_layer.html">

            
                <a href="../part3_src/dropout_layer.html">
            
                    
                    dropout_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.19" 
            data-path="../part3_src/gemm.html">

            
                <a href="../part3_src/gemm.html">
            
                    
                    gemm.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.20" 
            data-path="../part3_src/gru_layer.html">

            
                <a href="../part3_src/gru_layer.html">
            
                    
                    gru_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.21" 
            data-path="../part3_src/im2col.html">

            
                <a href="../part3_src/im2col.html">
            
                    
                    im2col.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.22" 
            data-path="../part3_src/image.html">

            
                <a href="../part3_src/image.html">
            
                    
                    image.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.23" 
            data-path="../part3_src/iseg_layer.html">

            
                <a href="../part3_src/iseg_layer.html">
            
                    
                    iseg_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.24" 
            data-path="../part3_src/l2norm_layer.html">

            
                <a href="../part3_src/l2norm_layer.html">
            
                    
                    l2norm_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.25" 
            data-path="../part3_src/layer.html">

            
                <a href="../part3_src/layer.html">
            
                    
                    layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.26" 
            data-path="../part3_src/list.html">

            
                <a href="../part3_src/list.html">
            
                    
                    list.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.27" 
            data-path="../part3_src/local_layer.html">

            
                <a href="../part3_src/local_layer.html">
            
                    
                    local_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.28" 
            data-path="../part3_src/logistic_layer.html">

            
                <a href="../part3_src/logistic_layer.html">
            
                    
                    logistic_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.29" 
            data-path="../part3_src/lstm_layer.html">

            
                <a href="../part3_src/lstm_layer.html">
            
                    
                    lstm_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.30" 
            data-path="../part3_src/matrix.html">

            
                <a href="../part3_src/matrix.html">
            
                    
                    matrix.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.31" 
            data-path="../part3_src/maxpool.html">

            
                <a href="../part3_src/maxpool.html">
            
                    
                    maxpool_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.32" 
            data-path="../part3_src/network.html">

            
                <a href="../part3_src/network.html">
            
                    
                    network.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.33" 
            data-path="../part3_src/normalization_layer.html">

            
                <a href="../part3_src/normalization_layer.html">
            
                    
                    normalization_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.34" 
            data-path="../part3_src/option_list.html">

            
                <a href="../part3_src/option_list.html">
            
                    
                    option_list.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.35" 
            data-path="../part3_src/parser_1.html">

            
                <a href="../part3_src/parser_1.html">
            
                    
                    parser.c
            
                </a>
            

            
            <ul class="articles">
                
                
    
        
        <li class="chapter 
               hide "
            data-level="5.35.1" 
            data-path="../part3_src/parser_2.html">

            
                <a href="../part3_src/parser_2.html">
            
                    
                    + parser.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.36" 
            data-path="../part3_src/region_layer.html">

            
                <a href="../part3_src/region_layer.html">
            
                    
                    region_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.37" 
            data-path="../part3_src/reorg_layer.html">

            
                <a href="../part3_src/reorg_layer.html">
            
                    
                    reorg_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.38" 
            data-path="../part3_src/rnn_layer.html">

            
                <a href="../part3_src/rnn_layer.html">
            
                    
                    rnn_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.39" 
            data-path="../part3_src/route_layer.html">

            
                <a href="../part3_src/route_layer.html">
            
                    
                    route_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.40" 
            data-path="../part3_src/shortcut.md">

            
                <span>
            
                    
                    shortcut_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.41" 
            data-path="../part3_src/softmax_layer.html">

            
                <a href="../part3_src/softmax_layer.html">
            
                    
                    softmax_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.42" 
            data-path="../part3_src/tree.html">

            
                <a href="../part3_src/tree.html">
            
                    
                    tree.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.43" 
            data-path="../part3_src/upsample_layer.html">

            
                <a href="../part3_src/upsample_layer.html">
            
                    
                    upsample_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.44" 
            data-path="../part3_src/utils.html">

            
                <a href="../part3_src/utils.html">
            
                    
                    utils.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.45" 
            data-path="../part3_src/yolo_layer.html">

            
                <a href="../part3_src/yolo_layer.html">
            
                    
                    yolo_layer.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="5.46" 
            data-path="../part3_src/image_opencv.html">

            
                <a href="../part3_src/image_opencv.html">
            
                    
                    image_opencv.cpp
            
                </a>
            

            
        </li>
    

    
        
        
        <li class="header  selected ">/EXAMPLE</li>
        
        
    
        
        <li class="chapter 
              "
            data-level="6.1" 
            data-path="art.html">

            
                <a href="art.html">
            
                    
                    art.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.2" 
            data-path="attention.html">

            
                <a href="attention.html">
            
                    
                    attention.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.3" 
            data-path="captcha.html">

            
                <a href="captcha.html">
            
                    
                    captcha.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.4" 
            data-path="cifar.html">

            
                <a href="cifar.html">
            
                    
                    cifar.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.5" 
            data-path="classifier.html">

            
                <a href="classifier.html">
            
                    
                    classifier.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.6" 
            data-path="coco.html">

            
                <a href="coco.html">
            
                    
                    coco.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.7" 
            data-path="darknet.html">

            
                <a href="darknet.html">
            
                    
                    darknet.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.8" 
            data-path="detector.html">

            
                <a href="detector.html">
            
                    
                    detector.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.9" 
            data-path="dice.html">

            
                <a href="dice.html">
            
                    
                    dice.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.10" 
            data-path="go.html">

            
                <a href="go.html">
            
                    
                    go.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.11" 
            data-path="instance-segmenter.html">

            
                <a href="instance-segmenter.html">
            
                    
                    instance-segmenter.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
            active  selected  "
            data-level="6.12" 
            data-path="lsd.html">

            
                <a href="lsd.html">
            
                    
                    lsd.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.13" 
            data-path="nightmare.html">

            
                <a href="nightmare.html">
            
                    
                    nightmare.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.14" 
            data-path="regressor.html">

            
                <a href="regressor.html">
            
                    
                    regressor.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.15" 
            data-path="rnn.html">

            
                <a href="rnn.html">
            
                    
                    rnn.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.16" 
            data-path="rnn_vid.html">

            
                <a href="rnn_vid.html">
            
                    
                    rnn_vid.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.17" 
            data-path="segmenter.html">

            
                <a href="segmenter.html">
            
                    
                    segmenter.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.18" 
            data-path="super.html">

            
                <a href="super.html">
            
                    
                    super.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.19" 
            data-path="swag.html">

            
                <a href="swag.html">
            
                    
                    swag.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.20" 
            data-path="tag.html">

            
                <a href="tag.html">
            
                    
                    tag.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.21" 
            data-path="voxel.html">

            
                <a href="voxel.html">
            
                    
                    voxel.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.22" 
            data-path="writing.html">

            
                <a href="writing.html">
            
                    
                    writing.c
            
                </a>
            

            
        </li>
    
        
        <li class="chapter 
              "
            data-level="6.23" 
            data-path="yolo.html">

            
                <a href="yolo.html">
            
                    
                    yolo.c
            
                </a>
            

            
        </li>
    

    
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >lsd.c</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="lsdc">lsd.c</h1>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;darknet.h&quot;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">slerp</span><span class="hljs-params">(<span class="hljs-keyword">float</span> *start, <span class="hljs-keyword">float</span> *end, <span class="hljs-keyword">float</span> s, <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">float</span> *out)</span>
</span>{
    <span class="hljs-keyword">float</span> omega = <span class="hljs-built_in">acos</span>(dot_cpu(n, start, <span class="hljs-number">1</span>, end, <span class="hljs-number">1</span>));
    <span class="hljs-keyword">float</span> so = <span class="hljs-built_in">sin</span>(omega);
    fill_cpu(n, <span class="hljs-number">0</span>, out, <span class="hljs-number">1</span>);
    axpy_cpu(n, <span class="hljs-built_in">sin</span>((<span class="hljs-number">1</span>-s)*omega)/so, start, <span class="hljs-number">1</span>, out, <span class="hljs-number">1</span>);
    axpy_cpu(n, <span class="hljs-built_in">sin</span>(s*omega)/so, end, <span class="hljs-number">1</span>, out, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">float</span> mag = mag_array(out, n);
    scale_array(out, n, <span class="hljs-number">1.</span>/mag);
}

<span class="hljs-function">image <span class="hljs-title">random_unit_vector_image</span><span class="hljs-params">(<span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h, <span class="hljs-keyword">int</span> c)</span>
</span>{
    image im = make_image(w, h, c);
    <span class="hljs-keyword">int</span> i;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; im.w*im.h*im.c; ++i){
        im.data[i] = rand_normal();
    }
    <span class="hljs-keyword">float</span> mag = mag_array(im.data, im.w*im.h*im.c);
    scale_array(im.data, im.w*im.h*im.c, <span class="hljs-number">1.</span>/mag);
    <span class="hljs-keyword">return</span> im;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">inter_dcgan</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile)</span>
</span>{
    network *net = load_network(cfgfile, weightfile, <span class="hljs-number">0</span>);
    set_batch_network(net, <span class="hljs-number">1</span>);
    srand(<span class="hljs-number">2222222</span>);

    <span class="hljs-keyword">clock_t</span> time;
    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">char</span> *input = buff;
    <span class="hljs-keyword">int</span> i, imlayer = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; net-&gt;n; ++i) {
        <span class="hljs-keyword">if</span> (net-&gt;layers[i].out_c == <span class="hljs-number">3</span>) {
            imlayer = i;
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, i);
            <span class="hljs-keyword">break</span>;
        }
    }
    image start = random_unit_vector_image(net-&gt;w, net-&gt;h, net-&gt;c);
    image end = random_unit_vector_image(net-&gt;w, net-&gt;h, net-&gt;c);
        image im = make_image(net-&gt;w, net-&gt;h, net-&gt;c);
        image orig = copy_image(start);

    <span class="hljs-keyword">int</span> c = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> max_count = <span class="hljs-number">15</span>;
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
        ++c;

        <span class="hljs-keyword">if</span>(count == max_count){
            count = <span class="hljs-number">0</span>;
            free_image(start);
            start = end;
            end = random_unit_vector_image(net-&gt;w, net-&gt;h, net-&gt;c);
            <span class="hljs-keyword">if</span>(c &gt; <span class="hljs-number">300</span>){
                end = orig;
            }
            <span class="hljs-keyword">if</span>(c&gt;<span class="hljs-number">300</span> + max_count) <span class="hljs-keyword">return</span>;
        }
        ++count;

        slerp(start.data, end.data, (<span class="hljs-keyword">float</span>)count / max_count, im.w*im.h*im.c, im.data);

        <span class="hljs-keyword">float</span> *X = im.data;
        time=clock();
        network_predict(net, X);
        image out = get_network_image_layer(net, imlayer);
        <span class="hljs-comment">//yuv_to_rgb(out);</span>
        normalize_image(out);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: Predicted in %f seconds.\n&quot;</span>, input, sec(clock()-time));
        <span class="hljs-comment">//char buff[256];</span>
        <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;out%05d&quot;</span>, c);
        save_image(out, <span class="hljs-string">&quot;out&quot;</span>);
        save_image(out, buff);
        show_image(out, <span class="hljs-string">&quot;out&quot;</span>, <span class="hljs-number">0</span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_dcgan</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile)</span>
</span>{
    network *net = load_network(cfgfile, weightfile, <span class="hljs-number">0</span>);
    set_batch_network(net, <span class="hljs-number">1</span>);
    srand(<span class="hljs-number">2222222</span>);

    <span class="hljs-keyword">clock_t</span> time;
    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">char</span> *input = buff;
    <span class="hljs-keyword">int</span> imlayer = <span class="hljs-number">0</span>;

    imlayer = net-&gt;n<span class="hljs-number">-1</span>;

    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
        image im = make_image(net-&gt;w, net-&gt;h, net-&gt;c);
        <span class="hljs-keyword">int</span> i;
        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; im.w*im.h*im.c; ++i){
            im.data[i] = rand_normal();
        }
        <span class="hljs-comment">//float mag = mag_array(im.data, im.w*im.h*im.c);</span>
        <span class="hljs-comment">//scale_array(im.data, im.w*im.h*im.c, 1./mag);</span>

        <span class="hljs-keyword">float</span> *X = im.data;
        time=clock();
        network_predict(net, X);
        image out = get_network_image_layer(net, imlayer);
        <span class="hljs-comment">//yuv_to_rgb(out);</span>
        normalize_image(out);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: Predicted in %f seconds.\n&quot;</span>, input, sec(clock()-time));
        save_image(out, <span class="hljs-string">&quot;out&quot;</span>);
        show_image(out, <span class="hljs-string">&quot;out&quot;</span>, <span class="hljs-number">0</span>);

        free_image(im);
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">set_network_alpha_beta</span><span class="hljs-params">(network *net, <span class="hljs-keyword">float</span> alpha, <span class="hljs-keyword">float</span> beta)</span>
</span>{
    <span class="hljs-keyword">int</span> i;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; net-&gt;n; ++i){
        <span class="hljs-keyword">if</span>(net-&gt;layers[i].type == SHORTCUT){
            net-&gt;layers[i].alpha = alpha;
            net-&gt;layers[i].beta = beta;
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">train_prog</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cfg, <span class="hljs-keyword">char</span> *weight, <span class="hljs-keyword">char</span> *acfg, <span class="hljs-keyword">char</span> *aweight, <span class="hljs-keyword">int</span> clear, <span class="hljs-keyword">int</span> display, <span class="hljs-keyword">char</span> *train_images, <span class="hljs-keyword">int</span> maxbatch)</span>
</span>{
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span>
    <span class="hljs-keyword">char</span> *backup_directory = <span class="hljs-string">&quot;/home/pjreddie/backup/&quot;</span>;
    srand(time(<span class="hljs-number">0</span>));
    <span class="hljs-keyword">char</span> *base = basecfg(cfg);
    <span class="hljs-keyword">char</span> *abase = basecfg(acfg);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, base);
    network *gnet = load_network(cfg, weight, clear);
    network *anet = load_network(acfg, aweight, clear);

    <span class="hljs-keyword">int</span> i, j, k;
    layer imlayer = gnet-&gt;layers[gnet-&gt;n<span class="hljs-number">-1</span>];

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Learning Rate: %g, Momentum: %g, Decay: %g\n&quot;</span>, gnet-&gt;learning_rate, gnet-&gt;momentum, gnet-&gt;decay);
    <span class="hljs-keyword">int</span> imgs = gnet-&gt;batch*gnet-&gt;subdivisions;
    i = *gnet-&gt;seen/imgs;
    data train, buffer;


    <span class="hljs-built_in">list</span> *plist = get_paths(train_images);
    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);

    load_args args= get_base_args(anet);
    args.paths = paths;
    args.n = imgs;
    args.m = plist-&gt;size;
    args.d = &amp;buffer;
    args.type = CLASSIFICATION_DATA;
    args.threads=<span class="hljs-number">16</span>;
    args.classes = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">char</span> *ls[<span class="hljs-number">2</span>] = {<span class="hljs-string">&quot;imagenet&quot;</span>, <span class="hljs-string">&quot;zzzzzzzz&quot;</span>};
    args.labels = ls;

    <span class="hljs-keyword">pthread_t</span> load_thread = load_data_in_thread(args);
    <span class="hljs-keyword">clock_t</span> time;

    gnet-&gt;train = <span class="hljs-number">1</span>;
    anet-&gt;train = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">int</span> x_size = gnet-&gt;inputs*gnet-&gt;batch;
    <span class="hljs-keyword">int</span> y_size = gnet-&gt;truths*gnet-&gt;batch;
    <span class="hljs-keyword">float</span> *imerror = cuda_make_array(<span class="hljs-number">0</span>, y_size);

    <span class="hljs-keyword">float</span> aloss_avg = <span class="hljs-number">-1</span>;

    <span class="hljs-keyword">if</span> (maxbatch == <span class="hljs-number">0</span>) maxbatch = gnet-&gt;max_batches;
    <span class="hljs-keyword">while</span> (get_current_batch(gnet) &lt; maxbatch) {
        {
            <span class="hljs-keyword">int</span> cb = get_current_batch(gnet);
            <span class="hljs-keyword">float</span> alpha = (<span class="hljs-keyword">float</span>) cb / (maxbatch/<span class="hljs-number">2</span>);
            <span class="hljs-keyword">if</span>(alpha &gt; <span class="hljs-number">1</span>) alpha = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">float</span> beta = <span class="hljs-number">1</span> - alpha;
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f %f\n&quot;</span>, alpha, beta);
            set_network_alpha_beta(gnet, alpha, beta);
            set_network_alpha_beta(anet, beta, alpha);
        }

        i += <span class="hljs-number">1</span>;
        time=clock();
        pthread_join(load_thread, <span class="hljs-number">0</span>);
        train = buffer;

        load_thread = load_data_in_thread(args);

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Loaded: %lf seconds\n&quot;</span>, sec(clock()-time));

        data gen = copy_data(train);
        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; imgs; ++j) {
            train.y.vals[j][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
            gen.y.vals[j][<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
        }
        time=clock();

        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; gnet-&gt;subdivisions; ++j) {
            get_next_batch(train, gnet-&gt;batch, j*gnet-&gt;batch, gnet-&gt;truth, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">int</span> z;
            <span class="hljs-keyword">for</span>(z = <span class="hljs-number">0</span>; z &lt; x_size; ++z){
                gnet-&gt;input[z] = rand_normal();
            }
            <span class="hljs-comment">/*
               for(z = 0; z &lt; gnet-&gt;batch; ++z){
               float mag = mag_array(gnet-&gt;input + z*gnet-&gt;inputs, gnet-&gt;inputs);
               scale_array(gnet-&gt;input + z*gnet-&gt;inputs, gnet-&gt;inputs, 1./mag);
               }
             */</span>
            *gnet-&gt;seen += gnet-&gt;batch;
            forward_network(gnet);

            fill_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">0</span>, imerror, <span class="hljs-number">1</span>);
            fill_cpu(anet-&gt;truths*anet-&gt;batch, <span class="hljs-number">1</span>, anet-&gt;truth, <span class="hljs-number">1</span>);
            copy_cpu(anet-&gt;inputs*anet-&gt;batch, imlayer.output, <span class="hljs-number">1</span>, anet-&gt;input, <span class="hljs-number">1</span>);
            anet-&gt;delta_gpu = imerror;
            forward_network(anet);
            backward_network(anet);

            <span class="hljs-comment">//float genaloss = *anet-&gt;cost / anet-&gt;batch;</span>

            scal_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1</span>, imerror, <span class="hljs-number">1</span>);
            scal_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">0</span>, gnet-&gt;layers[gnet-&gt;n<span class="hljs-number">-1</span>].delta_gpu, <span class="hljs-number">1</span>);

            axpy_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1</span>, imerror, <span class="hljs-number">1</span>, gnet-&gt;layers[gnet-&gt;n<span class="hljs-number">-1</span>].delta_gpu, <span class="hljs-number">1</span>);

            backward_network(gnet);

            <span class="hljs-keyword">for</span>(k = <span class="hljs-number">0</span>; k &lt; gnet-&gt;batch; ++k){
                <span class="hljs-keyword">int</span> index = j*gnet-&gt;batch + k;
                copy_cpu(gnet-&gt;outputs, gnet-&gt;output + k*gnet-&gt;outputs, <span class="hljs-number">1</span>, gen.X.vals[index], <span class="hljs-number">1</span>);
            }
        }
        harmless_update_network_gpu(anet);

        data merge = concat_data(train, gen);
        <span class="hljs-keyword">float</span> aloss = train_network(anet, merge);

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> OPENCV</span>
        <span class="hljs-keyword">if</span>(display){
            image im = float_to_image(anet-&gt;w, anet-&gt;h, anet-&gt;c, gen.X.vals[<span class="hljs-number">0</span>]);
            image im2 = float_to_image(anet-&gt;w, anet-&gt;h, anet-&gt;c, train.X.vals[<span class="hljs-number">0</span>]);
            show_image(im, <span class="hljs-string">&quot;gen&quot;</span>, <span class="hljs-number">1</span>);
            show_image(im2, <span class="hljs-string">&quot;train&quot;</span>, <span class="hljs-number">1</span>);
            save_image(im, <span class="hljs-string">&quot;gen&quot;</span>);
            save_image(im2, <span class="hljs-string">&quot;train&quot;</span>);
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

        update_network_gpu(gnet);

        free_data(merge);
        free_data(train);
        free_data(gen);
        <span class="hljs-keyword">if</span> (aloss_avg &lt; <span class="hljs-number">0</span>) aloss_avg = aloss;
        aloss_avg = aloss_avg*<span class="hljs-number">.9</span> + aloss*<span class="hljs-number">.1</span>;

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: adv: %f | adv_avg: %f, %f rate, %lf seconds, %d images\n&quot;</span>, i, aloss, aloss_avg, get_current_rate(gnet), sec(clock()-time), i*imgs);
        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">10000</span>==<span class="hljs-number">0</span>){
            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_%d.weights&quot;</span>, backup_directory, base, i);
            save_weights(gnet, buff);
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_%d.weights&quot;</span>, backup_directory, abase, i);
            save_weights(anet, buff);
        }
        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">1000</span>==<span class="hljs-number">0</span>){
            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s.backup&quot;</span>, backup_directory, base);
            save_weights(gnet, buff);
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s.backup&quot;</span>, backup_directory, abase);
            save_weights(anet, buff);
        }
    }
    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
    <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_final.weights&quot;</span>, backup_directory, base);
    save_weights(gnet, buff);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">train_dcgan</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cfg, <span class="hljs-keyword">char</span> *weight, <span class="hljs-keyword">char</span> *acfg, <span class="hljs-keyword">char</span> *aweight, <span class="hljs-keyword">int</span> clear, <span class="hljs-keyword">int</span> display, <span class="hljs-keyword">char</span> *train_images, <span class="hljs-keyword">int</span> maxbatch)</span>
</span>{
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span>
    <span class="hljs-keyword">char</span> *backup_directory = <span class="hljs-string">&quot;/home/pjreddie/backup/&quot;</span>;
    srand(time(<span class="hljs-number">0</span>));
    <span class="hljs-keyword">char</span> *base = basecfg(cfg);
    <span class="hljs-keyword">char</span> *abase = basecfg(acfg);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, base);
    network *gnet = load_network(cfg, weight, clear);
    network *anet = load_network(acfg, aweight, clear);
    <span class="hljs-comment">//float orig_rate = anet-&gt;learning_rate;</span>

    <span class="hljs-keyword">int</span> i, j, k;
    layer imlayer = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; gnet-&gt;n; ++i) {
        <span class="hljs-keyword">if</span> (gnet-&gt;layers[i].out_c == <span class="hljs-number">3</span>) {
            imlayer = gnet-&gt;layers[i];
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Learning Rate: %g, Momentum: %g, Decay: %g\n&quot;</span>, gnet-&gt;learning_rate, gnet-&gt;momentum, gnet-&gt;decay);
    <span class="hljs-keyword">int</span> imgs = gnet-&gt;batch*gnet-&gt;subdivisions;
    i = *gnet-&gt;seen/imgs;
    data train, buffer;


    <span class="hljs-built_in">list</span> *plist = get_paths(train_images);
    <span class="hljs-comment">//int N = plist-&gt;size;</span>
    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);

    load_args args= get_base_args(anet);
    args.paths = paths;
    args.n = imgs;
    args.m = plist-&gt;size;
    args.d = &amp;buffer;
    args.type = CLASSIFICATION_DATA;
    args.threads=<span class="hljs-number">16</span>;
    args.classes = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">char</span> *ls[<span class="hljs-number">2</span>] = {<span class="hljs-string">&quot;imagenet&quot;</span>, <span class="hljs-string">&quot;zzzzzzzz&quot;</span>};
    args.labels = ls;

    <span class="hljs-keyword">pthread_t</span> load_thread = load_data_in_thread(args);
    <span class="hljs-keyword">clock_t</span> time;

    gnet-&gt;train = <span class="hljs-number">1</span>;
    anet-&gt;train = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">int</span> x_size = gnet-&gt;inputs*gnet-&gt;batch;
    <span class="hljs-keyword">int</span> y_size = gnet-&gt;truths*gnet-&gt;batch;
    <span class="hljs-keyword">float</span> *imerror = cuda_make_array(<span class="hljs-number">0</span>, y_size);

    <span class="hljs-comment">//int ay_size = anet-&gt;truths*anet-&gt;batch;</span>

    <span class="hljs-keyword">float</span> aloss_avg = <span class="hljs-number">-1</span>;

    <span class="hljs-comment">//data generated = copy_data(train);</span>

    <span class="hljs-keyword">if</span> (maxbatch == <span class="hljs-number">0</span>) maxbatch = gnet-&gt;max_batches;
    <span class="hljs-keyword">while</span> (get_current_batch(gnet) &lt; maxbatch) {
        i += <span class="hljs-number">1</span>;
        time=clock();
        pthread_join(load_thread, <span class="hljs-number">0</span>);
        train = buffer;

        <span class="hljs-comment">//translate_data_rows(train, -.5);</span>
        <span class="hljs-comment">//scale_data_rows(train, 2);</span>

        load_thread = load_data_in_thread(args);

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Loaded: %lf seconds\n&quot;</span>, sec(clock()-time));

        data gen = copy_data(train);
        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; imgs; ++j) {
            train.y.vals[j][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
            gen.y.vals[j][<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
        }
        time=clock();

        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; gnet-&gt;subdivisions; ++j){
            get_next_batch(train, gnet-&gt;batch, j*gnet-&gt;batch, gnet-&gt;truth, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">int</span> z;
            <span class="hljs-keyword">for</span>(z = <span class="hljs-number">0</span>; z &lt; x_size; ++z){
                gnet-&gt;input[z] = rand_normal();
            }
            <span class="hljs-keyword">for</span>(z = <span class="hljs-number">0</span>; z &lt; gnet-&gt;batch; ++z){
                <span class="hljs-keyword">float</span> mag = mag_array(gnet-&gt;input + z*gnet-&gt;inputs, gnet-&gt;inputs);
                scale_array(gnet-&gt;input + z*gnet-&gt;inputs, gnet-&gt;inputs, <span class="hljs-number">1.</span>/mag);
            }
            <span class="hljs-comment">/*
               for(z = 0; z &lt; 100; ++z){
               printf(&quot;%f, &quot;, gnet-&gt;input[z]);
               }
               printf(&quot;\n&quot;);
               printf(&quot;input: %f %f\n&quot;, mean_array(gnet-&gt;input, x_size), variance_array(gnet-&gt;input, x_size));
             */</span>

            <span class="hljs-comment">//cuda_push_array(gnet-&gt;input_gpu, gnet-&gt;input, x_size);</span>
            <span class="hljs-comment">//cuda_push_array(gnet-&gt;truth_gpu, gnet-&gt;truth, y_size);</span>
            *gnet-&gt;seen += gnet-&gt;batch;
            forward_network(gnet);

            fill_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">0</span>, imerror, <span class="hljs-number">1</span>);
            fill_cpu(anet-&gt;truths*anet-&gt;batch, <span class="hljs-number">1</span>, anet-&gt;truth, <span class="hljs-number">1</span>);
            copy_cpu(anet-&gt;inputs*anet-&gt;batch, imlayer.output, <span class="hljs-number">1</span>, anet-&gt;input, <span class="hljs-number">1</span>);
            anet-&gt;delta_gpu = imerror;
            forward_network(anet);
            backward_network(anet);

            <span class="hljs-comment">//float genaloss = *anet-&gt;cost / anet-&gt;batch;</span>
            <span class="hljs-comment">//printf(&quot;%f\n&quot;, genaloss);</span>

            scal_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1</span>, imerror, <span class="hljs-number">1</span>);
            scal_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">0</span>, gnet-&gt;layers[gnet-&gt;n<span class="hljs-number">-1</span>].delta_gpu, <span class="hljs-number">1</span>);

            <span class="hljs-comment">//printf(&quot;realness %f\n&quot;, cuda_mag_array(imerror, imlayer.outputs*imlayer.batch));</span>
            <span class="hljs-comment">//printf(&quot;features %f\n&quot;, cuda_mag_array(gnet-&gt;layers[gnet-&gt;n-1].delta_gpu, imlayer.outputs*imlayer.batch));</span>

            axpy_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1</span>, imerror, <span class="hljs-number">1</span>, gnet-&gt;layers[gnet-&gt;n<span class="hljs-number">-1</span>].delta_gpu, <span class="hljs-number">1</span>);

            backward_network(gnet);

            <span class="hljs-comment">/*
               for(k = 0; k &lt; gnet-&gt;n; ++k){
               layer l = gnet-&gt;layers[k];
               cuda_pull_array(l.output_gpu, l.output, l.outputs*l.batch);
               printf(&quot;%d: %f %f\n&quot;, k, mean_array(l.output, l.outputs*l.batch), variance_array(l.output, l.outputs*l.batch));
               }
             */</span>

            <span class="hljs-keyword">for</span>(k = <span class="hljs-number">0</span>; k &lt; gnet-&gt;batch; ++k){
                <span class="hljs-keyword">int</span> index = j*gnet-&gt;batch + k;
                copy_cpu(gnet-&gt;outputs, gnet-&gt;output + k*gnet-&gt;outputs, <span class="hljs-number">1</span>, gen.X.vals[index], <span class="hljs-number">1</span>);
            }
        }
        harmless_update_network_gpu(anet);

        data merge = concat_data(train, gen);
        <span class="hljs-comment">//randomize_data(merge);</span>
        <span class="hljs-keyword">float</span> aloss = train_network(anet, merge);

        <span class="hljs-comment">//translate_image(im, 1);</span>
        <span class="hljs-comment">//scale_image(im, .5);</span>
        <span class="hljs-comment">//translate_image(im2, 1);</span>
        <span class="hljs-comment">//scale_image(im2, .5);</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> OPENCV</span>
        <span class="hljs-keyword">if</span>(display){
            image im = float_to_image(anet-&gt;w, anet-&gt;h, anet-&gt;c, gen.X.vals[<span class="hljs-number">0</span>]);
            image im2 = float_to_image(anet-&gt;w, anet-&gt;h, anet-&gt;c, train.X.vals[<span class="hljs-number">0</span>]);
            show_image(im, <span class="hljs-string">&quot;gen&quot;</span>, <span class="hljs-number">1</span>);
            show_image(im2, <span class="hljs-string">&quot;train&quot;</span>, <span class="hljs-number">1</span>);
            save_image(im, <span class="hljs-string">&quot;gen&quot;</span>);
            save_image(im2, <span class="hljs-string">&quot;train&quot;</span>);
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

        <span class="hljs-comment">/*
           if(aloss &lt; .1){
           anet-&gt;learning_rate = 0;
           } else if (aloss &gt; .3){
           anet-&gt;learning_rate = orig_rate;
           }
         */</span>

        update_network_gpu(gnet);

        free_data(merge);
        free_data(train);
        free_data(gen);
        <span class="hljs-keyword">if</span> (aloss_avg &lt; <span class="hljs-number">0</span>) aloss_avg = aloss;
        aloss_avg = aloss_avg*<span class="hljs-number">.9</span> + aloss*<span class="hljs-number">.1</span>;

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: adv: %f | adv_avg: %f, %f rate, %lf seconds, %d images\n&quot;</span>, i, aloss, aloss_avg, get_current_rate(gnet), sec(clock()-time), i*imgs);
        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">10000</span>==<span class="hljs-number">0</span>){
            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_%d.weights&quot;</span>, backup_directory, base, i);
            save_weights(gnet, buff);
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_%d.weights&quot;</span>, backup_directory, abase, i);
            save_weights(anet, buff);
        }
        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">1000</span>==<span class="hljs-number">0</span>){
            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s.backup&quot;</span>, backup_directory, base);
            save_weights(gnet, buff);
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s.backup&quot;</span>, backup_directory, abase);
            save_weights(anet, buff);
        }
    }
    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
    <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_final.weights&quot;</span>, backup_directory, base);
    save_weights(gnet, buff);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">train_colorizer</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cfg, <span class="hljs-keyword">char</span> *weight, <span class="hljs-keyword">char</span> *acfg, <span class="hljs-keyword">char</span> *aweight, <span class="hljs-keyword">int</span> clear, <span class="hljs-keyword">int</span> display)</span>
</span>{
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span>
    <span class="hljs-comment">//char *train_images = &quot;/home/pjreddie/data/coco/train1.txt&quot;;</span>
    <span class="hljs-comment">//char *train_images = &quot;/home/pjreddie/data/coco/trainvalno5k.txt&quot;;</span>
    <span class="hljs-keyword">char</span> *train_images = <span class="hljs-string">&quot;/home/pjreddie/data/imagenet/imagenet1k.train.list&quot;</span>;
    <span class="hljs-keyword">char</span> *backup_directory = <span class="hljs-string">&quot;/home/pjreddie/backup/&quot;</span>;
    srand(time(<span class="hljs-number">0</span>));
    <span class="hljs-keyword">char</span> *base = basecfg(cfg);
    <span class="hljs-keyword">char</span> *abase = basecfg(acfg);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, base);
    network *net = load_network(cfg, weight, clear);
    network *anet = load_network(acfg, aweight, clear);

    <span class="hljs-keyword">int</span> i, j, k;
    layer imlayer = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; net-&gt;n; ++i) {
        <span class="hljs-keyword">if</span> (net-&gt;layers[i].out_c == <span class="hljs-number">3</span>) {
            imlayer = net-&gt;layers[i];
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Learning Rate: %g, Momentum: %g, Decay: %g\n&quot;</span>, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);
    <span class="hljs-keyword">int</span> imgs = net-&gt;batch*net-&gt;subdivisions;
    i = *net-&gt;seen/imgs;
    data train, buffer;


    <span class="hljs-built_in">list</span> *plist = get_paths(train_images);
    <span class="hljs-comment">//int N = plist-&gt;size;</span>
    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);

    load_args args= get_base_args(net);
    args.paths = paths;
    args.n = imgs;
    args.m = plist-&gt;size;
    args.d = &amp;buffer;

    args.type = CLASSIFICATION_DATA;
    args.classes = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">char</span> *ls[<span class="hljs-number">2</span>] = {<span class="hljs-string">&quot;imagenet&quot;</span>};
    args.labels = ls;

    <span class="hljs-keyword">pthread_t</span> load_thread = load_data_in_thread(args);
    <span class="hljs-keyword">clock_t</span> time;

    <span class="hljs-keyword">int</span> x_size = net-&gt;inputs*net-&gt;batch;
    <span class="hljs-comment">//int y_size = x_size;</span>
    net-&gt;delta = <span class="hljs-number">0</span>;
    net-&gt;train = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">float</span> *pixs = <span class="hljs-built_in">calloc</span>(x_size, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));
    <span class="hljs-keyword">float</span> *graypixs = <span class="hljs-built_in">calloc</span>(x_size, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));
    <span class="hljs-comment">//float *y = calloc(y_size, sizeof(float));</span>

    <span class="hljs-comment">//int ay_size = anet-&gt;outputs*anet-&gt;batch;</span>
    anet-&gt;delta = <span class="hljs-number">0</span>;
    anet-&gt;train = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">float</span> *imerror = cuda_make_array(<span class="hljs-number">0</span>, imlayer.outputs*imlayer.batch);

    <span class="hljs-keyword">float</span> aloss_avg = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">float</span> gloss_avg = <span class="hljs-number">-1</span>;

    <span class="hljs-comment">//data generated = copy_data(train);</span>

    <span class="hljs-keyword">while</span> (get_current_batch(net) &lt; net-&gt;max_batches) {
        i += <span class="hljs-number">1</span>;
        time=clock();
        pthread_join(load_thread, <span class="hljs-number">0</span>);
        train = buffer;
        load_thread = load_data_in_thread(args);

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Loaded: %lf seconds\n&quot;</span>, sec(clock()-time));

        data gray = copy_data(train);
        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; imgs; ++j){
            image gim = float_to_image(net-&gt;w, net-&gt;h, net-&gt;c, gray.X.vals[j]);
            grayscale_image_3c(gim);
            train.y.vals[j][<span class="hljs-number">0</span>] = <span class="hljs-number">.95</span>;
            gray.y.vals[j][<span class="hljs-number">0</span>] = <span class="hljs-number">.05</span>;
        }
        time=clock();
        <span class="hljs-keyword">float</span> gloss = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; net-&gt;subdivisions; ++j){
            get_next_batch(train, net-&gt;batch, j*net-&gt;batch, pixs, <span class="hljs-number">0</span>);
            get_next_batch(gray, net-&gt;batch, j*net-&gt;batch, graypixs, <span class="hljs-number">0</span>);
            cuda_push_array(net-&gt;input_gpu, graypixs, net-&gt;inputs*net-&gt;batch);
            cuda_push_array(net-&gt;truth_gpu, pixs, net-&gt;truths*net-&gt;batch);
            <span class="hljs-comment">/*
               image origi = float_to_image(net-&gt;w, net-&gt;h, 3, pixs);
               image grayi = float_to_image(net-&gt;w, net-&gt;h, 3, graypixs);
               show_image(grayi, &quot;gray&quot;);
               show_image(origi, &quot;orig&quot;);
               cvWaitKey(0);
             */</span>
            *net-&gt;seen += net-&gt;batch;
            forward_network_gpu(net);

            fill_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">0</span>, imerror, <span class="hljs-number">1</span>);
            copy_gpu(anet-&gt;inputs*anet-&gt;batch, imlayer.output_gpu, <span class="hljs-number">1</span>, anet-&gt;input_gpu, <span class="hljs-number">1</span>);
            fill_gpu(anet-&gt;inputs*anet-&gt;batch, <span class="hljs-number">.95</span>, anet-&gt;truth_gpu, <span class="hljs-number">1</span>);
            anet-&gt;delta_gpu = imerror;
            forward_network_gpu(anet);
            backward_network_gpu(anet);

            scal_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1.</span>/<span class="hljs-number">100.</span>, net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>].delta_gpu, <span class="hljs-number">1</span>);

            scal_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1</span>, imerror, <span class="hljs-number">1</span>);

            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;realness %f\n&quot;</span>, cuda_mag_array(imerror, imlayer.outputs*imlayer.batch));
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;features %f\n&quot;</span>, cuda_mag_array(net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>].delta_gpu, imlayer.outputs*imlayer.batch));

            axpy_gpu(imlayer.outputs*imlayer.batch, <span class="hljs-number">1</span>, imerror, <span class="hljs-number">1</span>, net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>].delta_gpu, <span class="hljs-number">1</span>);

            backward_network_gpu(net);


            gloss += *net-&gt;cost /(net-&gt;subdivisions*net-&gt;batch);

            <span class="hljs-keyword">for</span>(k = <span class="hljs-number">0</span>; k &lt; net-&gt;batch; ++k){
                <span class="hljs-keyword">int</span> index = j*net-&gt;batch + k;
                copy_cpu(imlayer.outputs, imlayer.output + k*imlayer.outputs, <span class="hljs-number">1</span>, gray.X.vals[index], <span class="hljs-number">1</span>);
            }
        }
        harmless_update_network_gpu(anet);

        data merge = concat_data(train, gray);
        <span class="hljs-comment">//randomize_data(merge);</span>
        <span class="hljs-keyword">float</span> aloss = train_network(anet, merge);

        update_network_gpu(net);

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> OPENCV</span>
        <span class="hljs-keyword">if</span>(display){
            image im = float_to_image(anet-&gt;w, anet-&gt;h, anet-&gt;c, gray.X.vals[<span class="hljs-number">0</span>]);
            image im2 = float_to_image(anet-&gt;w, anet-&gt;h, anet-&gt;c, train.X.vals[<span class="hljs-number">0</span>]);
            show_image(im, <span class="hljs-string">&quot;gen&quot;</span>, <span class="hljs-number">1</span>);
            show_image(im2, <span class="hljs-string">&quot;train&quot;</span>, <span class="hljs-number">1</span>);
        }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        free_data(merge);
        free_data(train);
        free_data(gray);
        <span class="hljs-keyword">if</span> (aloss_avg &lt; <span class="hljs-number">0</span>) aloss_avg = aloss;
        aloss_avg = aloss_avg*<span class="hljs-number">.9</span> + aloss*<span class="hljs-number">.1</span>;
        gloss_avg = gloss_avg*<span class="hljs-number">.9</span> + gloss*<span class="hljs-number">.1</span>;

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: gen: %f, adv: %f | gen_avg: %f, adv_avg: %f, %f rate, %lf seconds, %d images\n&quot;</span>, i, gloss, aloss, gloss_avg, aloss_avg, get_current_rate(net), sec(clock()-time), i*imgs);
        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">1000</span>==<span class="hljs-number">0</span>){
            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_%d.weights&quot;</span>, backup_directory, base, i);
            save_weights(net, buff);
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_%d.weights&quot;</span>, backup_directory, abase, i);
            save_weights(anet, buff);
        }
        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">100</span>==<span class="hljs-number">0</span>){
            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s.backup&quot;</span>, backup_directory, base);
            save_weights(net, buff);
            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s.backup&quot;</span>, backup_directory, abase);
            save_weights(anet, buff);
        }
    }
    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
    <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">&quot;%s/%s_final.weights&quot;</span>, backup_directory, base);
    save_weights(net, buff);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
}

<span class="hljs-comment">/*
   void train_lsd2(char *cfgfile, char *weightfile, char *acfgfile, char *aweightfile, int clear)
   {
#ifdef GPU
char *train_images = &quot;/home/pjreddie/data/coco/trainvalno5k.txt&quot;;
char *backup_directory = &quot;/home/pjreddie/backup/&quot;;
srand(time(0));
char *base = basecfg(cfgfile);
printf(&quot;%s\n&quot;, base);
network net = parse_network_cfg(cfgfile);
if(weightfile){
load_weights(&amp;net, weightfile);
}
if(clear) *net-&gt;seen = 0;

char *abase = basecfg(acfgfile);
network anet = parse_network_cfg(acfgfile);
if(aweightfile){
load_weights(&amp;anet, aweightfile);
}
if(clear) *anet-&gt;seen = 0;

int i, j, k;
layer imlayer = {0};
for (i = 0; i &lt; net-&gt;n; ++i) {
if (net-&gt;layers[i].out_c == 3) {
imlayer = net-&gt;layers[i];
break;
}
}

printf(&quot;Learning Rate: %g, Momentum: %g, Decay: %g\n&quot;, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);
int imgs = net-&gt;batch*net-&gt;subdivisions;
i = *net-&gt;seen/imgs;
data train, buffer;


list *plist = get_paths(train_images);
//int N = plist-&gt;size;
char **paths = (char **)list_to_array(plist);

load_args args = {0};
args.w = net-&gt;w;
args.h = net-&gt;h;
args.paths = paths;
args.n = imgs;
args.m = plist-&gt;size;
args.d = &amp;buffer;

args.min = net-&gt;min_crop;
args.max = net-&gt;max_crop;
args.angle = net-&gt;angle;
args.aspect = net-&gt;aspect;
args.exposure = net-&gt;exposure;
args.saturation = net-&gt;saturation;
args.hue = net-&gt;hue;
args.size = net-&gt;w;
args.type = CLASSIFICATION_DATA;
args.classes = 1;
char *ls[1] = {&quot;coco&quot;};
args.labels = ls;

pthread_t load_thread = load_data_in_thread(args);
clock_t time;

network_state gstate = {0};
gstate.index = 0;
gstate.net = net;
int x_size = get_network_input_size(net)*net-&gt;batch;
int y_size = 1*net-&gt;batch;
gstate.input = cuda_make_array(0, x_size);
gstate.truth = 0;
gstate.delta = 0;
gstate.train = 1;
float *X = calloc(x_size, sizeof(float));
float *y = calloc(y_size, sizeof(float));

network_state astate = {0};
astate.index = 0;
astate.net = anet;
int ay_size = get_network_output_size(anet)*anet-&gt;batch;
astate.input = 0;
astate.truth = 0;
astate.delta = 0;
astate.train = 1;

float *imerror = cuda_make_array(0, imlayer.outputs);
float *ones_gpu = cuda_make_array(0, ay_size);
fill_gpu(ay_size, 1, ones_gpu, 1);

float aloss_avg = -1;
float gloss_avg = -1;

//data generated = copy_data(train);

while (get_current_batch(net) &lt; net-&gt;max_batches) {
    i += 1;
    time=clock();
    pthread_join(load_thread, 0);
    train = buffer;
    load_thread = load_data_in_thread(args);

    printf(&quot;Loaded: %lf seconds\n&quot;, sec(clock()-time));

    data generated = copy_data(train);
    time=clock();
    float gloss = 0;

    for(j = 0; j &lt; net-&gt;subdivisions; ++j){
        get_next_batch(train, net-&gt;batch, j*net-&gt;batch, X, y);
        cuda_push_array(gstate.input, X, x_size);
        *net-&gt;seen += net-&gt;batch;
        forward_network_gpu(net, gstate);

        fill_gpu(imlayer.outputs, 0, imerror, 1);
        astate.input = imlayer.output_gpu;
        astate.delta = imerror;
        astate.truth = ones_gpu;
        forward_network_gpu(anet, astate);
        backward_network_gpu(anet, astate);

        scal_gpu(imlayer.outputs, 1, imerror, 1);
        axpy_gpu(imlayer.outputs, 1, imerror, 1, imlayer.delta_gpu, 1);

        backward_network_gpu(net, gstate);

        printf(&quot;features %f\n&quot;, cuda_mag_array(imlayer.delta_gpu, imlayer.outputs));
        printf(&quot;realness %f\n&quot;, cuda_mag_array(imerror, imlayer.outputs));

        gloss += get_network_cost(net) /(net-&gt;subdivisions*net-&gt;batch);

        cuda_pull_array(imlayer.output_gpu, imlayer.output, imlayer.outputs*imlayer.batch);
        for(k = 0; k &lt; net-&gt;batch; ++k){
            int index = j*net-&gt;batch + k;
            copy_cpu(imlayer.outputs, imlayer.output + k*imlayer.outputs, 1, generated.X.vals[index], 1);
            generated.y.vals[index][0] = 0;
        }
    }
    harmless_update_network_gpu(anet);

    data merge = concat_data(train, generated);
    randomize_data(merge);
    float aloss = train_network(anet, merge);

    update_network_gpu(net);
    update_network_gpu(anet);
    free_data(merge);
    free_data(train);
    free_data(generated);
    if (aloss_avg &lt; 0) aloss_avg = aloss;
    aloss_avg = aloss_avg*.9 + aloss*.1;
    gloss_avg = gloss_avg*.9 + gloss*.1;

    printf(&quot;%d: gen: %f, adv: %f | gen_avg: %f, adv_avg: %f, %f rate, %lf seconds, %d images\n&quot;, i, gloss, aloss, gloss_avg, aloss_avg, get_current_rate(net), sec(clock()-time), i*imgs);
    if(i%1000==0){
        char buff[256];
        sprintf(buff, &quot;%s/%s_%d.weights&quot;, backup_directory, base, i);
        save_weights(net, buff);
        sprintf(buff, &quot;%s/%s_%d.weights&quot;, backup_directory, abase, i);
        save_weights(anet, buff);
    }
    if(i%100==0){
        char buff[256];
        sprintf(buff, &quot;%s/%s.backup&quot;, backup_directory, base);
        save_weights(net, buff);
        sprintf(buff, &quot;%s/%s.backup&quot;, backup_directory, abase);
        save_weights(anet, buff);
    }
}
char buff[256];
sprintf(buff, &quot;%s/%s_final.weights&quot;, backup_directory, base);
save_weights(net, buff);
#endif
}
*/</span>

<span class="hljs-comment">/*
   void train_lsd(char *cfgfile, char *weightfile, int clear)
   {
   char *train_images = &quot;/home/pjreddie/data/coco/trainvalno5k.txt&quot;;
   char *backup_directory = &quot;/home/pjreddie/backup/&quot;;
   srand(time(0));
   char *base = basecfg(cfgfile);
   printf(&quot;%s\n&quot;, base);
   float avg_loss = -1;
   network net = parse_network_cfg(cfgfile);
   if(weightfile){
   load_weights(&amp;net, weightfile);
   }
   if(clear) *net-&gt;seen = 0;
   printf(&quot;Learning Rate: %g, Momentum: %g, Decay: %g\n&quot;, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);
   int imgs = net-&gt;batch*net-&gt;subdivisions;
   int i = *net-&gt;seen/imgs;
   data train, buffer;


   list *plist = get_paths(train_images);
//int N = plist-&gt;size;
char **paths = (char **)list_to_array(plist);

load_args args = {0};
args.w = net-&gt;w;
args.h = net-&gt;h;
args.paths = paths;
args.n = imgs;
args.m = plist-&gt;size;
args.d = &amp;buffer;

args.min = net-&gt;min_crop;
args.max = net-&gt;max_crop;
args.angle = net-&gt;angle;
args.aspect = net-&gt;aspect;
args.exposure = net-&gt;exposure;
args.saturation = net-&gt;saturation;
args.hue = net-&gt;hue;
args.size = net-&gt;w;
args.type = CLASSIFICATION_DATA;
args.classes = 1;
char *ls[1] = {&quot;coco&quot;};
args.labels = ls;

pthread_t load_thread = load_data_in_thread(args);
clock_t time;
//while(i*imgs &lt; N*120){
while(get_current_batch(net) &lt; net-&gt;max_batches){
i += 1;
time=clock();
pthread_join(load_thread, 0);
train = buffer;
load_thread = load_data_in_thread(args);

printf(&quot;Loaded: %lf seconds\n&quot;, sec(clock()-time));

time=clock();
float loss = train_network(net, train);
if (avg_loss &lt; 0) avg_loss = loss;
avg_loss = avg_loss*.9 + loss*.1;

printf(&quot;%d: %f, %f avg, %f rate, %lf seconds, %d images\n&quot;, i, loss, avg_loss, get_current_rate(net), sec(clock()-time), i*imgs);
if(i%1000==0){
char buff[256];
sprintf(buff, &quot;%s/%s_%d.weights&quot;, backup_directory, base, i);
save_weights(net, buff);
}
if(i%100==0){
char buff[256];
sprintf(buff, &quot;%s/%s.backup&quot;, backup_directory, base);
save_weights(net, buff);
}
free_data(train);
}
char buff[256];
sprintf(buff, &quot;%s/%s_final.weights&quot;, backup_directory, base);
save_weights(net, buff);
}
*/</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_lsd</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cfg, <span class="hljs-keyword">char</span> *weights, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">int</span> gray)</span>
</span>{
    network *net = load_network(cfg, weights, <span class="hljs-number">0</span>);
    set_batch_network(net, <span class="hljs-number">1</span>);
    srand(<span class="hljs-number">2222222</span>);

    <span class="hljs-keyword">clock_t</span> time;
    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">char</span> *input = buff;
    <span class="hljs-keyword">int</span> i, imlayer = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; net-&gt;n; ++i) {
        <span class="hljs-keyword">if</span> (net-&gt;layers[i].out_c == <span class="hljs-number">3</span>) {
            imlayer = i;
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, i);
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
        <span class="hljs-keyword">if</span>(filename){
            <span class="hljs-built_in">strncpy</span>(input, filename, <span class="hljs-number">256</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter Image Path: &quot;</span>);
            fflush(<span class="hljs-built_in">stdout</span>);
            input = fgets(input, <span class="hljs-number">256</span>, <span class="hljs-built_in">stdin</span>);
            <span class="hljs-keyword">if</span>(!input) <span class="hljs-keyword">return</span>;
            strtok(input, <span class="hljs-string">&quot;\n&quot;</span>);
        }
        image im = load_image_color(input, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        image resized = resize_min(im, net-&gt;w);
        image crop = crop_image(resized, (resized.w - net-&gt;w)/<span class="hljs-number">2</span>, (resized.h - net-&gt;h)/<span class="hljs-number">2</span>, net-&gt;w, net-&gt;h);
        <span class="hljs-keyword">if</span>(gray) grayscale_image_3c(crop);

        <span class="hljs-keyword">float</span> *X = crop.data;
        time=clock();
        network_predict(net, X);
        image out = get_network_image_layer(net, imlayer);
        <span class="hljs-comment">//yuv_to_rgb(out);</span>
        constrain_image(out);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: Predicted in %f seconds.\n&quot;</span>, input, sec(clock()-time));
        save_image(out, <span class="hljs-string">&quot;out&quot;</span>);
        show_image(out, <span class="hljs-string">&quot;out&quot;</span>, <span class="hljs-number">1</span>);
        show_image(crop, <span class="hljs-string">&quot;crop&quot;</span>, <span class="hljs-number">0</span>);

        free_image(im);
        free_image(resized);
        free_image(crop);
        <span class="hljs-keyword">if</span> (filename) <span class="hljs-keyword">break</span>;
    }
}


<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run_lsd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">4</span>){
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: %s %s [train/test/valid] [cfg] [weights (optional)]\n&quot;</span>, argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">int</span> clear = find_arg(argc, argv, <span class="hljs-string">&quot;-clear&quot;</span>);
    <span class="hljs-keyword">int</span> display = find_arg(argc, argv, <span class="hljs-string">&quot;-display&quot;</span>);
    <span class="hljs-keyword">int</span> batches = find_int_arg(argc, argv, <span class="hljs-string">&quot;-b&quot;</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">char</span> *file = find_char_arg(argc, argv, <span class="hljs-string">&quot;-file&quot;</span>, <span class="hljs-string">&quot;/home/pjreddie/data/imagenet/imagenet1k.train.list&quot;</span>);

    <span class="hljs-keyword">char</span> *cfg = argv[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">char</span> *weights = (argc &gt; <span class="hljs-number">4</span>) ? argv[<span class="hljs-number">4</span>] : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> *filename = (argc &gt; <span class="hljs-number">5</span>) ? argv[<span class="hljs-number">5</span>] : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> *acfg = argv[<span class="hljs-number">5</span>];
    <span class="hljs-keyword">char</span> *aweights = (argc &gt; <span class="hljs-number">6</span>) ? argv[<span class="hljs-number">6</span>] : <span class="hljs-number">0</span>;
    <span class="hljs-comment">//if(0==strcmp(argv[2], &quot;train&quot;)) train_lsd(cfg, weights, clear);</span>
    <span class="hljs-comment">//else if(0==strcmp(argv[2], &quot;train2&quot;)) train_lsd2(cfg, weights, acfg, aweights, clear);</span>
    <span class="hljs-comment">//else if(0==strcmp(argv[2], &quot;traincolor&quot;)) train_colorizer(cfg, weights, acfg, aweights, clear);</span>
    <span class="hljs-comment">//else if(0==strcmp(argv[2], &quot;train3&quot;)) train_lsd3(argv[3], argv[4], argv[5], argv[6], argv[7], argv[8], clear);</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;traingan&quot;</span>)) train_dcgan(cfg, weights, acfg, aweights, clear, display, file, batches);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;trainprog&quot;</span>)) train_prog(cfg, weights, acfg, aweights, clear, display, file, batches);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;traincolor&quot;</span>)) train_colorizer(cfg, weights, acfg, aweights, clear, display);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;gan&quot;</span>)) test_dcgan(cfg, weights);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;inter&quot;</span>)) inter_dcgan(cfg, weights);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;test&quot;</span>)) test_lsd(cfg, weights, filename, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;color&quot;</span>)) test_lsd(cfg, weights, filename, <span class="hljs-number">1</span>);
    <span class="hljs-comment">/*
       else if(0==strcmp(argv[2], &quot;valid&quot;)) validate_lsd(cfg, weights);
     */</span>
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="instance-segmenter.html" class="navigation navigation-prev " aria-label="Previous page: instance-segmenter.c">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="nightmare.html" class="navigation navigation-next " aria-label="Next page: nightmare.c">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"lsd.c","level":"6.12","depth":1,"next":{"title":"nightmare.c","level":"6.13","depth":1,"path":"part5_examples/nightmare.md","ref":"part5_examples/nightmare.md","articles":[]},"previous":{"title":"instance-segmenter.c","level":"6.11","depth":1,"path":"part5_examples/instance-segmenter.md","ref":"part5_examples/instance-segmenter.md","articles":[]},"dir":"ltr"},"config":{"plugins":["advanced-emoji","theme-gestalt","-theme-default","styles-sass-fix","theme-api","mathjax","ga"],"root":"./","styles":{"website":"website-1600186244488.css"},"pluginsConfig":{"styles-sass-fix":{},"theme-gestalt":{"showLevel":false,"styles":{"website":"styles/website.css"},"logo":"/darknet_book/assets/darknet.png","baseUrl":null,"excludeDefaultStyles":true,"doNotHideChildrenChapters":false},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"theme-api":{"languages":[],"split":true,"theme":"light"},"mathjax":{"forceSVG":false,"version":"2.6-latest"},"ga":{"configuration":"auto","token":"UA-136921229-1"},"advanced-emoji":{"embedEmojis":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]}},"theme":"default","author":"JJM","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"BASE_URL":"https://jjeamin.github.io"},"title":"DarkNet Book","output.name":"site","gitbook":"*"},"file":{"path":"part5_examples/lsd.md","mtime":"2020-09-15T15:58:25.513Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-09-15T16:10:39.415Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-api/theme-api.js"></script>
        
    

    </body>
</html>

